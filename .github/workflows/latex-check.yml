name: LaTeX and ZIP Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  verify:
    if: github.repository == 'yursds/TeamTex'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compile LaTeX document (Pass 1)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          compiler: pdflatex
          args: -interaction=nonstopmode -file-line-error -halt-on-error -output-directory=build

      - name: Compile Bibliography
        uses: xu-cheng/latex-action@v3
        with:
          root_file: build/main
          compiler: bibtex
          args: ""
        continue-on-error: true

      - name: Compile LaTeX document (Pass 2)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          compiler: pdflatex
          args: -interaction=nonstopmode -file-line-error -halt-on-error -output-directory=build

      - name: Compile LaTeX document (Pass 3)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          compiler: pdflatex
          args: -interaction=nonstopmode -file-line-error -halt-on-error -output-directory=build

      - name: Verify build artifacts
        run: |
          if [ ! -f build/main.pdf ]; then
            echo "Error: PDF not generated!"
            exit 1
          fi

      - name: Test Source Export Script
        run: |
          chmod +x export_source.sh
          ./export_source.sh
          if [ ! -f teamtex_source.zip ]; then
            echo "Error: ZIP export failed!"
            exit 1
          fi

      - name: Verify ZIP Privacy
        run: |
          # Use unzip -l to list files and grep for forbidden ones
          unzip -l teamtex_source.zip > zip_content.txt
          if grep -q "LICENSE" zip_content.txt; then
            echo "Error: LICENSE found in ZIP export!"
            exit 1
          fi
          if grep -E -q "(\.git/|\.devcontainer/|\.github/)" zip_content.txt; then
            echo "Error: Configuration folders found in ZIP export!"
            exit 1
          fi
          echo "ZIP verification passed!"
